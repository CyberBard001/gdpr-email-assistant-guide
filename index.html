<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GDPR Email Assistant ‚Äì Setup & Usage Guide</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      line-height: 1.6;
      max-width: 800px;
      margin: 2rem auto;
      padding: 1rem;
      background: #fefefe;
      color: #222;
    }
    h1 {
      font-size: 1.8rem;
      margin-bottom: 1rem;
    }
    h2 {
      margin-top: 2rem;
      color: #0a558c;
    }
    li {
      margin-bottom: 0.5em;
    }
    code {
      background: #eee;
      padding: 2px 5px;
      border-radius: 3px;
    }
    pre {
      background: #f4f4f4;
      padding: 1em;
      overflow-x: auto;
      border-radius: 6px;
      position: relative;
    }
    button.copy-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      padding: 5px 10px;
      font-size: 0.9em;
      cursor: pointer;
    }
    details summary {
      font-weight: bold;
      cursor: pointer;
      margin-top: 1em;
    }
    .check {
      color: green;
      margin-right: 5px;
    }
  </style>
</head>
<body>
  <h1>GDPR Email Assistant ‚Äì Setup & Usage Guide</h1>

  <h2><span class="check">‚úÖ</span> Step 1: Create Your Google Sheet</h2>
  <ul>
    <li>Open a new Google Sheet and name it <strong>GDPR Email Assistant</strong></li>
    <li>Add a tab called <code>Senders</code> and in Row 1, enter these headers:<br />
      <code>Sender Email</code> | <code>First Detected</code> | <code>Status</code> | <code>Action Taken On</code> | <code>Notes</code> | <code>Domain</code>
    </li>
    <li>Add a second tab called <code>Instructions</code> for usage steps.</li>
  </ul>

  <h2><span class="check">‚úÖ</span> Step 2: Paste the Script</h2>
  <ul>
    <li>Go to <strong>Extensions ‚Üí Apps Script</strong></li>
    <li>Delete any starter code</li>
    <li>Paste in the script provided below</li>
    <li>Click <strong>Save</strong></li>
  </ul>

  <details>
    <summary>üìú Click to View Script (with Copy Button)</summary>
    <pre><button class="copy-btn" onclick="copyScript()">Copy</button><code id="script">
function sendGDPRRequests() {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Senders');
  const data = sheet.getDataRange().getValues();

  const messageBody = `Dear Data Controller,\n\nUnder Article 17 of the UK GDPR and/or EU GDPR, I formally request the erasure of any and all personal data you hold about me associated with this email address.\n\nI withdraw any consent previously given and request full deletion of my personal information from your systems, mailing lists, and third-party platforms where applicable. Please confirm when this request has been completed.\n\nSincerely,\nStuart Gibson\nstuartgibson1986@gmail.com`;

  for (let i = 1; i < data.length; i++) {
    const [email, , status, actionDate] = data[i];

    // Process rows where Status is "Approved" and "Action Taken On" is blank
    if (status.trim() === 'Approved' && actionDate === '') {
      try {
        GmailApp.sendEmail(email, "Request for Erasure of Personal Data under GDPR", messageBody, {
          name: "Stuart Gibson",
          replyTo: "stuartgibson1986@gmail.com"
        });
        
        // Update the sheet upon success
        const now = new Date();
        sheet.getRange(i + 1, 3).setValue("Sent");                 // Status -> "Sent"
        sheet.getRange(i + 1, 4).setValue(now);                    // Action Taken On -> current date
        sheet.getRange(i + 1, 5).setValue("‚úÖ Email sent on " + now.toLocaleString()); // Notes
        Logger.log(`‚úÖ GDPR request sent to: ${email}`);
        
      } catch (e) {
        sheet.getRange(i + 1, 5).setValue(`‚ùå Error: ${e.message}`); // Notes
        Logger.log(`‚ùå Error sending to ${email}: ${e.message}`);
      }
    }
  }
}

function logUniqueSendersToSheet() {
  const sheetName = 'Senders';
  const threads = GmailApp.search('in:anywhere newer_than:2y');
  const senders = new Set();

  threads.forEach(thread => {
    thread.getMessages().forEach(message => {
      const fromField = message.getFrom();
      const match = fromField.match(/<([^>]+)>/) || fromField.match(/([^ ]+@[^ ]+)/);
      if (match) {
        senders.add(match[1].trim().toLowerCase());
      }
    });
  });

  const ss = SpreadsheetApp.getActiveSpreadsheet();
  let sheet = ss.getSheetByName(sheetName);

  if (!sheet) {
    sheet = ss.insertSheet(sheetName);
    sheet.appendRow(['Sender Email', 'First Detected', 'Status', 'Action Taken On', 'Notes', 'Domain']);
  }

  const existing = sheet.getRange(2, 1, sheet.getLastRow() - 1 || 1, 1).getValues().flat();
  const newEntries = Array.from(senders).filter(email => !existing.includes(email));

  newEntries.forEach(email => {
    sheet.appendRow([email, new Date(), 'Pending', '', '', '']);
  });

  Logger.log(`‚úÖ Scanned ${threads.length} threads. Added ${newEntries.length} new senders.`);
}

function extractDomains() {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Senders');
  if (sheet.getLastRow() <= 1) return; 
  const range = sheet.getRange(2, 1, sheet.getLastRow() - 1, 6);
  const data = range.getValues(); 

  for (let i = 0; i < data.length; i++) {
    const email = data[i][0];
    if (email && email.includes('@')) {
      data[i][5] = email.split('@')[1].trim().toLowerCase(); 
    }
  }
  range.setValues(data); 
  Logger.log('‚úÖ Domains extracted into column F');
}

function cleanupDuplicatesByDomain() {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Senders');
  if (sheet.getLastRow() <= 1) return;
  const range = sheet.getRange(2, 1, sheet.getLastRow() - 1, 6);
  const data = range.getValues();

  const seenDomains = new Set();

  for (let i = 0; i < data.length; i++) {
    const domain = data[i][5]; 
    const status = data[i][2]; 
    
    if (!domain || status === 'Removed') continue;

    if (seenDomains.has(domain)) {
      data[i][2] = 'Removed'; 
      data[i][4] = 'Duplicate of domain'; 
    } else {
      seenDomains.add(domain);
    }
  }
  range.setValues(data); 
  Logger.log('‚úÖ Cleanup complete ‚Äî one row kept per domain.');
}
</code></pre>
  </details>

  <h2><span class="check">‚úÖ</span> Step 3: First-Time Manual Run</h2>
  <ul>
    <li>Run <code>logUniqueSendersToSheet</code></li>
    <li>Run <code>extractDomains</code></li>
    <li>Run <code>cleanupDuplicatesByDomain</code></li>
    <li>Mark rows in the sheet as <strong>Approved</strong>, <strong>Ignore</strong>, or <strong>Removed</strong></li>
    <li>Run <code>sendGDPRRequests</code> to email approved senders</li>
  </ul>

  <h2><span class="check">‚úÖ</span> Step 4: Use the Custom Menu</h2>
  <p>
    Once the script is run, a new menu will appear in your sheet called <code>GDPR Tools</code>.
    It will let you run everything with a click.
  </p>

  <script>
    function copyScript() {
      const scriptContent = document.getElementById("script").innerText;
      navigator.clipboard.writeText(scriptContent)
        .then(() => alert("‚úÖ Script copied to clipboard!"))
        .catch(() => alert("‚ùå Failed to copy script."));
    }
  </script>
</body>
</html>
